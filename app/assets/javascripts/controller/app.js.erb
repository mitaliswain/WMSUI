var wms = angular.module('WMSUI', ['ngRoute' , 'xeditable', 'ui.bootstrap', 'ui.router']);
var login = angular.module('login', ["ngRoute", "ui.bootstrap"]);


wms.run(function(editableOptions) {
    editableOptions.theme = 'bs3';
});


// configure our routes
wms.config(function($stateProvider, $urlRouterProvider) {

    $urlRouterProvider.otherwise('/');

    $stateProvider

        // route for the shipment page
            .state('shipment_maintenance', {
                url:         '/shipment_maintenance',
                templateUrl: '<%= asset_path('shipment_maintenance/index.html') %>',
                controller:  'ShipmentListCtrl'
            })

        // edit shipment header page
            .state('edit_shipment_header', {
                url:         '/shipment_maintenance/edit_shipment/:header_id/',
                templateUrl: '<%= asset_path('shipment_maintenance/show_header.html') %>',
                controller:  'ShipmentEditCtrl'
            })

        // edit the shipment detail page
            .state('edit_shipment_detail', {
                url:         '/shipment_maintenance/edit_shipment/:header_id/:detail_id',
                templateUrl: '<%= asset_path('shipment_maintenance/show_detail.html') %>',
                controller:  'ShipmentEditCtrl'
            })

           // route for the add shipment header
            .state('add_shipment_header', {
                url        : '/shipment_maintenance/add_shipment_header',
                templateUrl: '<%= asset_path('shipment_maintenance/add_header.html') %>',
                controller : 'ShipmentAddCtrl'
            })

        // route for the shipment detail page
            .state('add_shipment_detail', {
                url:         '/shipment_maintenance/add_shipment_detail/:to_shipment_header_id',
                templateUrl: '<%= asset_path('shipment_maintenance/add_detail.html') %>',
                controller:  'ShipmentAddCtrl'
            })

        // route for the case page
            .state('case_maintenance', {
                url:         '/case_maintenance',
                templateUrl: '<%= asset_path('case_maintenance/index.html') %>',
                controller:  'CaseListCtrl'
            })

        // edit case header page
            .state('edit_case_header', {
                url:         '/case_maintenance/edit_case/:header_id/',
                templateUrl: '<%= asset_path('case_maintenance/show_header.html') %>',
                controller:  'CaseEditCtrl'
            })

        // edit the case detail page
            .state('edit_case_detail', {
                url:         '/case_maintenance/edit_case/:header_id/:detail_id',
                templateUrl: '<%= asset_path('case_maintenance/show_detail.html') %>',
                controller:  'CaseEditCtrl'
            })

        // route for the add case header
            .state('add_case_header', {
                url        : '/case_maintenance/add_case_header',
                templateUrl: '<%= asset_path('case_maintenance/add_header.html') %>',
                controller : 'CaseAddCtrl'
            })

        // route for the case detail page
            .state('add_case_detail', {
                url:         '/case_maintenance/add_case_detail/:to_case_header_id',
                templateUrl: '<%= asset_path('case_maintenance/add_detail.html') %>',
                controller:  'CaseAddCtrl'
            })


        // route for the item master page
            .state('item_master_maintenance', {
                url:         '/item_master_maintenance',
                templateUrl: '<%= asset_path('item_master_maintenance/index.html') %>',
                controller:  'ItemMasterListCtrl'
            })

        // edit item master header page
            .state('item_master_header', {
                url:         '/item_master_maintenance/edit_item/:header_id/',
                templateUrl: '<%= asset_path('item_master_maintenance/show_header.html') %>',
                controller:  'ItemMasterEditCtrl'
            })

        // route for the add item master
            .state('add_item_master', {
                url        : '/item_master_maintenance/add_item',
                templateUrl: '<%= asset_path('item_master_maintenance/add_item.html') %>',
                controller : 'ItemMasterAddCtrl'
            })


        // route for the configuration master page
            .state('configuration_maintenance', {
                url:         '/configuration_maintenance',
                templateUrl: '<%= asset_path('configuration_maintenance/index.html') %>',
                controller:  'ConfigurationListCtrl'
            })

        // edit configuration page
            .state('edit_configuration_header', {
                url:         '/configuration_maintenance/edit_configuration/:header_id/',
                templateUrl: '<%= asset_path('configuration_maintenance/show_header.html') %>',
                controller:  'ConfigurationEditCtrl'
            })

        // route for adding new configuration
            .state('add_configuration_header', {
                url        : '/configuration_maintenance/add_configuration',
                templateUrl: '<%= asset_path('configuration_maintenance/add_item.html') %>',
                controller : 'ConfigurationAddCtrl'
            })

});


wms.filter('search', function() {
    return function(array_of_objects, expected_value, search_by ) {
        var i =0;
        for (; i < array_of_objects.length ; i++) {
            if (array_of_objects[i][search_by] == expected_value) {
                return array_of_objects[i];
            }
        }
    }
});



wms.factory("ShareService", function() {
    var share_shipment = {shipment_header: {} , shipment_detail: {}};

    return {

        set_shipment : function(shipment) {
            share_shipment = shipment;
        },

        get_shipment : function() {
            return share_shipment;
        }

    };

});


wms.factory("UserService", function($http, $filter){

    return {

        findAndReplace:  function($scope, objId, newObj) {
            $scope.pagedItems[0].forEach(function(obj) {
                if (obj.item_header.id === objId) {
                    obj = newObj;
                    console.log(obj.item_header.id);
                }

                });
         },

        updateResource : function(data, el, id, url, $scope, $q) {

        var fields_to_update = {};
        fields_to_update[el.$editable.elem[0].id] = data;
        var d = $q.defer();
        $http.post(url, {
            'authenticity_token': $('meta[name="csrf-token"]').attr('content'),
             app_parameters: {'client': 'WM', 'warehouse': 'WH1','channel': '', 'building': ''},
            fields_to_update: fields_to_update
        })
                .success(function(res) {
                    res = res || {};
                    d.resolve();
                }).error(function(res){
                    console.log(res);
                    res = res || {};
                    if (res.status == 500) {
                        d.reject(res.message|| 'Server Error');
                    }
                    else {
                        d.reject(res.errors[0].message);
                    }
                });
        return d.promise;
    },

    set_page: function($scope) {

            $scope.sortingOrder = '';
            $scope.reverse = false;
            $scope.filteredItems = [];
            $scope.groupedItems = [];
            $scope.itemsPerPage = 8;
            $scope.pagedItems = [];
            $scope.currentPage = 0;


            var searchMatch = function (haystack, needle) {
                if (!needle || !haystack) {
                    return false;
                }

                if (typeof(haystack) == 'boolean') {
                    return haystack == needle
                }

                if (typeof(haystack) == 'string') {
                    return haystack.toLowerCase().lastIndexOf(needle.toLowerCase(),0) !== -1;
                }
            };

            // Filter by status
            $scope.status = function (status) {

                status = status==null ?  $scope.last_status : status;
                $scope.last_status = status;

                $scope.filteredItems = $filter('filter')($scope.items, function (item) {
                    if (searchMatch(item[$scope.filter_from_object][$scope.filter_from_field], status)) {
                        return true;
                    }

                    else {
                        return false;
                    }

                });
                // take care of the sorting order
                if ($scope.sortingOrder !== '') {
                    $scope.filteredItems = $filter('orderBy')($scope.filteredItems, $scope.sortingOrder, $scope.reverse);
                }
                $scope.currentPage = 0;
                groupToPages();
            };


            // calculate page in place
            var groupToPages = function () {
                $scope.pagedItems = [];

                for (var i = 0; i < $scope.filteredItems.length; i++) {
                    if (i % $scope.itemsPerPage === 0) {
                        $scope.pagedItems[Math.floor(i / $scope.itemsPerPage)] = [ $scope.filteredItems[i] ];
                    } else {
                        $scope.pagedItems[Math.floor(i / $scope.itemsPerPage)].push($scope.filteredItems[i]);
                    }
                }
            };

            // init the filtered items
            $scope.search = function (event, search_field) {

                if (event.which != 13) {
                    return
                }

                $scope.filteredItems = $filter('filter')($scope.items, function (item) {
                    if (searchMatch(item[$scope.filter_from_object][search_field], $scope.query) &&
                            searchMatch(item[$scope.filter_from_object][$scope.filter_from_field], $scope.last_status)) {
                        return true
                    }

                    else {
                        return false;
                    }
                });
                // take care of the sorting order
                if ($scope.sortingOrder !== '') {
                    $scope.filteredItems = $filter('orderBy')($scope.filteredItems, $scope.sortingOrder, $scope.reverse);
                }
                $scope.currentPage = 0;
                // now group by pages
                groupToPages();
            };

            $scope.range = function (start, end) {
                var ret = [];
                if (!end) {
                    end = start;
                    start = 0;
                }
                for (var i = start; i < end; i++) {
                    ret.push(i);
                }
                return ret;
            };

            $scope.prevPage = function () {
                if ($scope.currentPage > 0) {
                    $scope.currentPage--;
                }
            };

            $scope.nextPage = function () {
                if ($scope.currentPage < $scope.pagedItems.length - 1) {
                    $scope.currentPage++;
                }
            };

            $scope.setPage = function () {
                $scope.currentPage = this.n;
            };

            // change sorting order
            $scope.sort_by = function(newSortingOrder) {
                //if ($scope.sortingOrder == newSortingOrder)
                $scope.reverse = !$scope.reverse;

                $scope.sortingOrder = 'shipment_header.'+newSortingOrder;

                // take care of the sorting order
                $scope.filteredItems = $filter('orderBy')($scope.filteredItems, $scope.sortingOrder, $scope.reverse);
                $scope.currentPage = 0;
                // now group by pages
                groupToPages();
            };

        }


    }
});
