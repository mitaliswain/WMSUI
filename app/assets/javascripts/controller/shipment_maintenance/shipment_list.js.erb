wms.controller('ShipmentListCtrl', function ($scope, $http,  $location, $filter, $modal, $q, UserService) {

    $scope.last_status = 'Created';
    $scope.lastitem = {};
    $scope.detail  = {}
    $scope.header  = {}
    $scope.expand = 0
    $scope.squeeze = 100
    $scope.search_choice = {value: 'shipment_nbr', text: 'Shipment Number'}

    $scope.search_items = [
	    {value: 'shipment_nbr', text: 'Shipment Number'},
    	{value: 'purchase_order_nbr', text: 'Purchase Order Number'}
 	 ]; 

    $scope.choose = function(choice) {
    	$scope.search_choice = choice;
    	$scope.shipment_list = []
    	angular.forEach($scope.items, function(item) {
           	$scope.shipment_list.push(item["shipment_header"][$scope.search_choice.value]);
        });
    }
    
   $scope.shipment = 'new shipment';
   var url = '/shipment_maintenance.json?client=' + 'WM' + '&warehouse='+ 'WH1';

   var reload_modal_close =  function(){
       $scope.reload();
   }

    $scope.header_template = {
        name: 'header_template',
        url: '<%= asset_path('shipment_maintenance/shipment_header.html') %>'
    };

    $scope.detail_template = {
        name: 'detail_template',
        url: '<%= asset_path('shipment_maintenance/shipment_detail.html') %>'
    };

    $scope.show_shipment = function(show, shipment, shipment_detail_id) {
        var url = '/shipment_maintenance/'+  shipment + '.json'
        UserService.get_data($scope, url)
        
        if (show == 'Header') {
        	$scope.header.show= true
        	$scope.detail.show= false
        } else {
        	$scope.detail.show= true
        	$scope.header.show= false
        	angular.forEach($scope.shipment_details, function(shipment_detail) {
        		        	console.log(shipment_detail.id)
        		if (shipment_detail.id == shipment_detail_id){
           			 $scope.shipment_detail = shipment_detail;
        		}
   			});
        }
        
        $scope.expand = 50
        $scope.squeeze = 50
        $scope.selected_header_id = shipment        
    }

    $scope.hide_shipment = function() {
        $scope.header.show= false
        $scope.detail.show= false
        $scope.expand = 0
        $scope.squeeze = 100
    };


    $scope.toggle_expand = function(item) {
           item.show = !item.show;
           lastitem = item;
    };

    $scope.expand = function(item) {
        item.show = true;
    };


    //Modal methods
    $scope.shipment_add_modal = function (size) {
        var modalInstance = $modal.open({
            templateUrl: '<%= asset_path('shipment_maintenance/add_header.html') %>',
            controller: 'shipmentAddCtrl',
            size: size,
            resolve: {
                shipment: function () {
                    return null;
                }
            },
            backdrop : 'static',
            keyboard: false
        });
        modalInstance.result.then(reload_modal_close,reload_modal_close);
    };

    $scope.shipment_edit_modal = function (size, shipment) {
        var modalInstance = $modal.open({
            templateUrl: '<%= asset_path('shipment_maintenance/show_header.html') %>',
            controller: 'shipmentEditCtrl',
            size: size,
            resolve: {
                shipment: function () {
                    return shipment;
                },
                shipment_detail_id: function () {
                    return null;
                }
            },
            backdrop : 'static',
            keyboard: false
        });
        modalInstance.result.then(reload_modal_close,reload_modal_close);
    };


    $scope.shipment_detail_add_modal = function (size, shipment) {
        var modalInstance = $modal.open({
            templateUrl: '<%= asset_path('shipment_maintenance/add_detail.html') %>',
            controller: 'shipmentAddCtrl',
            size: size,
            resolve: {
                shipment: function () {
                    return shipment;
                },
                shipment_detail_id: function () {
                    return null;
                }
            },
            backdrop : 'static',
            keyboard: false
        });

       modalInstance.result.then(reload_modal_close,reload_modal_close);
    };

    $scope.shipment_detail_edit_modal = function (size, shipment, shipment_detail_id) {
        var modalInstance = $modal.open({
            templateUrl: '<%= asset_path('shipment_maintenance/show_detail.html') %>',
            controller: 'shipmentEditCtrl',
            size: size,
            resolve: {
                shipment: function () {
                    return shipment;
                },
                shipment_detail_id: function () {
                    return shipment_detail_id;
                }
            },
            backdrop : 'static',
            keyboard: false
        });
        modalInstance.result.then(reload_modal_close,reload_modal_close);
    };



    $scope.reload = function() {

        $http.get(url).success(function(data) {
            $scope.items = data;
            $scope.shipment_list = []

            $scope.filter_from_object = "shipment_header"
            $scope.filter_from_field = "record_status"

            UserService.set_page($scope);

            $scope.status(null);

            angular.forEach($scope.items, function(item) {
                $scope.shipment_list.push(item["shipment_header"][$scope.search_choice.value]);
            });

        });

    };

    $scope.reload();
});
