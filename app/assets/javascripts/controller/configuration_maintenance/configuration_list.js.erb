configuration.controller('ConfigurationListCtrl', function ($scope, $http,  $location, $filter, $q) {	
  var warehouse = $location.search().warehouse;
  var client    = $location.search().client; 
  var lastitem = {}; 
  var last_status;
  var url = '/configuration.json?client=' + 'WM' + '&warehouse='+ 'WH1';		
  $scope.options = [];
  $scope.TrueOrFalse = [
    {value: 'True', text: 'True'},
    {value: 'False', text: 'False'},
    ]; 
  
 $scope.update_configuration = function(data, el, id) {

    var warehouse = $location.search().warehouse;
    var client    = $location.search().client; 
    var fields_to_update = {};
    var url = '/configuration/'+ id;
	fields_to_update[el.$editable.elem[0].id] = data;
	var d = $q.defer();
    $http.put(url, {
    	'authenticity_token': $('meta[name="csrf-token"]').attr('content'),
    	app_parameters: {'client': 'WM', 'warehouse': 'WH1','channel': '', 'building': ''},
    	fields_to_update: fields_to_update
    	})
    	.success(function(res) {
	     	res = res || {};
	        d.resolve();
	    }).error(function(res){
	    	res = res || {};
	    	if (res.code == 500) {
	      		d.reject('Server error!');
	      	}
	      	else {	
	      		d.reject(res.errors[0].message);
	      	} 		
	    });
	    return d.promise;
 	};

		
    $scope.reload = function() {
	    $http.get(url).success(function(data) {
		    $scope.shipment_headers = data;
		    $scope.items = data; 
			
		    $scope.sortingOrder = sortingOrder;
		    $scope.reverse = false;
		    $scope.filteredItems = [];
		    $scope.groupedItems = [];
		    $scope.itemsPerPage = 8;
		    $scope.pagedItems = [];
		    $scope.currentPage = 0;
		    
		    $scope.loadGroups = function(key) {  
		    $scope.options = [];	   
  	   		angular.forEach(data, function(configuration) {
  	   			if (configuration.key == key) {
  	   					angular.forEach(JSON.parse(configuration.attribute1).Options, function(option){
  	   						$scope.options.push({value: option, text: option})
  	   					});

  	   			}
  	   			});  	   		
		    };
		    
		    var searchMatch = function (haystack, needle) {
		        if (!needle) {
		            return true;
		        }
		        return haystack.toLowerCase().indexOf(needle.toLowerCase()) !== -1;
		    };
		
		    
		    $scope.toggle_expand = function(item) {
		       item.show = !item.show;
		       lastitem = item;	       
		    };
		    
		    $scope.expand = function(item) {	
		 		item.show = true;	      
		    };
		    			
		
		    // Filter by status
		    $scope.status = function (status) {
		    	status = status==null ?  last_status : status;
		    	status = status==null ? 'Created' : status;
		    	last_status = status;   	
		        $scope.filteredItems = $filter('filter')($scope.items, function (item) {
		                //if (searchMatch(item["enable"], status))
		              	    return true;
		              	//else              	    
		            		//return false;
	
		        });
		        // take care of the sorting order
		        if ($scope.sortingOrder !== '') {
		            $scope.filteredItems = $filter('orderBy')($scope.filteredItems, $scope.sortingOrder, $scope.reverse);
		        }
		        $scope.currentPage = 0;
		        // now group by pages
		        $scope.groupToPages();
		    };
		
		    // init the filtered items
		    $scope.search = function () {
		        $scope.filteredItems = $filter('filter')($scope.items, function (item) {
		            //for(var attr in item) {
		                if (searchMatch(item["key"], $scope.query))
		              	    return true;
		              	else              	    		            
		            	return false;
		        	});
		        // take care of the sorting order
		        if ($scope.sortingOrder !== '') {
		            $scope.filteredItems = $filter('orderBy')($scope.filteredItems, $scope.sortingOrder, $scope.reverse);
		        }
		        $scope.currentPage = 0;
		        // now group by pages
		        $scope.groupToPages();
		   	 };
		    
		    
		  // calculate page in place
		  $scope.groupToPages = function () {
		        $scope.pagedItems = [];
		        
		        for (var i = 0; i < $scope.filteredItems.length; i++) {
		            if (i % $scope.itemsPerPage === 0) {
		                $scope.pagedItems[Math.floor(i / $scope.itemsPerPage)] = [ $scope.filteredItems[i] ];
		            } else {
		                $scope.pagedItems[Math.floor(i / $scope.itemsPerPage)].push($scope.filteredItems[i]);
		            }
		        }
		    };
		    
		    $scope.range = function (start, end) {
		        var ret = [];
		        if (!end) {
		            end = start;
		            start = 0;
		        }
		        for (var i = start; i < end; i++) {
		            ret.push(i);
		        }
		        return ret;
		    };
		    
		    $scope.prevPage = function () {
		        if ($scope.currentPage > 0) {
		            $scope.currentPage--;
		        }
		    };
		    
		    $scope.nextPage = function () {
		        if ($scope.currentPage < $scope.pagedItems.length - 1) {
		            $scope.currentPage++;
		        }
		    };
		    
		    $scope.setPage = function () {
		        $scope.currentPage = this.n;
		    };
		
		    // functions have been describe process the data for display
		    $scope.search();
		
		    // change sorting order
		    $scope.sort_by = function(newSortingOrder) {
		        if ($scope.sortingOrder == newSortingOrder)
		            $scope.reverse = !$scope.reverse;
		
		        $scope.sortingOrder = newSortingOrder;
		
		        // icon setup
		        $('th i').each(function(){
		            // icon reset
		            $(this).removeClass().addClass('icon-sort');
		        });
		        if ($scope.reverse)
		            $('th.'+new_sorting_order+' i').removeClass().addClass('icon-chevron-up');
		        else
		            $('th.'+new_sorting_order+' i').removeClass().addClass('icon-chevron-down');
		    };
		 $scope.expand(lastitem);	
		 $scope.status();
		 });
		
	 };
 
    $scope.reload();
});
